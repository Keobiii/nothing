  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: const CustomAppBar(title: "Hello, Kerby!"),
      backgroundColor: Colors.white,
      body: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.all(16.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [_addProductForm(context), _getProductData()],
          ),
        ),
      ),
    );
  }

  Form _getProductData() {
    return Form(
      child: Column(
        children: [
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                "Select a Product:",
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
              SizedBox(height: 10),
              DropdownButtonFormField<Product>(
                decoration: InputDecoration(border: OutlineInputBorder()),
                hint: Text("Choose a product"),
                value: selectedProduct,
                onChanged: (Product? newValue) {
                  setState(() {
                    isEditingMode = true;
                    selectedProduct = newValue;
                    _productIDController.text = newValue?.id.toString() ?? '';
                    _productNameController.text = newValue?.name ?? '';
                    _descriptionController.text = newValue?.description ?? '';
                    _priceController.text = newValue?.price.toString() ?? '';
                    _quantityController.text =
                        newValue?.totalQuantity.toString() ?? '';

                    selectedValue = newValue?.categoryId.toString() ?? '';
                  });
                },
                items:
                    allProducts.map((product) {
                      return DropdownMenuItem<Product>(
                        value: product,
                        child: Text(product.name),
                      );
                    }).toList(),
              ),
              SizedBox(height: 20),
              // Show selected product details
              // if (selectedProduct != null) ...[
              //   Text(
              //     "Product Details:",
              //     style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              //   ),
              //   SizedBox(height: 10),
              //   Text("ID: ${selectedProduct!.id}"),
              //   Text("Name: ${selectedProduct!.name}"),
              //   Text(
              //     "Category: ${_getCategoryName(selectedProduct!.categoryId)}",
              //   ),
              //   Text("Description: ${selectedProduct!.description}"),
              //   Text("Price: ${selectedProduct!.price}"),
              //   Text("Quantity: ${selectedProduct!.quantity}"),
              //   Text("Image: ${selectedProduct!.image}"),
              // ],
            ],
          ),
        ],
      ),
    );
  }

  // get category name by ID
  String _getCategoryName(int categoryId) {
    switch (categoryId) {
      case 1:
        return "T-Shirt";
      case 2:
        return "Polo-Shirt";
      case 3:
        return "Casual Wear";
      default:
        return "Unknown";
    }
  }

  Form _addProductForm(BuildContext context) {
    return Form(
      key: _formKey,
      child: Column(
        children: [
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text(
                'Add Product',
                style: TextStyle(fontSize: 27, fontWeight: FontWeight.bold),
              ),
            ],
          ),
          SizedBox(height: 50),
          isEditingMode
              ? CustomTextFormField(
                controller: _productIDController,
                labelText: 'Product ID',
                icon: Icons.person_outline_outlined,
                keyboardType: TextInputType.text,
                validator: (value) {
                  if (value == null || value.toString().isEmpty) {
                    return 'Please enter some text';
                  }
                  return null;
                },
              )
              : SizedBox(height: 0),

          CustomTextFormField(
            controller: _productNameController,
            labelText: 'Product Name',
            icon: Icons.person_outline_outlined,
            keyboardType: TextInputType.text,
            validator: (value) {
              if (value == null || value.toString().isEmpty) {
                return 'Please enter some text';
              }
              return null;
            },
          ),

          SizedBox(height: 20),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'Category',
                style: TextStyle(fontSize: 14, fontWeight: FontWeight.w600),
              ),
              SizedBox(height: 10),
              DropdownButtonFormField(
                decoration: InputDecoration(
                  enabledBorder: OutlineInputBorder(
                    borderSide: BorderSide(color: Colors.black, width: 2),
                    borderRadius: BorderRadius.circular(5),
                  ),
                  border: OutlineInputBorder(
                    borderSide: BorderSide(color: Colors.black, width: 2),
                    borderRadius: BorderRadius.circular(5),
                  ),
                  filled: true,
                  fillColor: Colors.white,
                ),
                validator:
                    (value) => value == null ? "Select a category" : null,
                dropdownColor: Colors.white,
                value: selectedValue,
                onChanged: (String? newValue) {
                  setState(() {
                    selectedValue = newValue!;
                  });
                },
                items: dropdownItems,
              ),

              SizedBox(height: 20),
              CustomTextFormField(
                controller: _descriptionController,
                labelText: 'Description',
                icon: Icons.person_outline_outlined,
                keyboardType: TextInputType.text,
                maxLiness: null,
                validator: (value) {
                  if (value == null || value.toString().isEmpty) {
                    return 'Please enter some text';
                  }
                  return null;
                },
              ),

              SizedBox(height: 20),
              CustomTextFormField(
                controller: _priceController,
                isNumber: true,
                labelText: 'Price',
                icon: Icons.person_outline_outlined,
                keyboardType: TextInputType.number,
                validator: (value) {
                  if (value == null || value.toString().isEmpty) {
                    return 'Please enter some text';
                  }
                  return null;
                },
              ),

              SizedBox(height: 20),
              CustomTextFormField(
                controller: _quantityController,
                isNumber: true,
                labelText: 'Quantity',
                icon: Icons.person_outline_outlined,
                keyboardType: TextInputType.number,
                validator: (value) {
                  if (value == null || value.toString().isEmpty) {
                    return 'Please enter some text';
                  }
                  return null;
                },
              ),

              SizedBox(height: 20),
              Container(
                width: double.infinity,
                height: 150,
                child: Column(
                  children: [
                    ElevatedButton(
                      onPressed: () {
                        if (_formKey.currentState!.validate()) {
                          final price_ = _priceController.text;
                          var finalPrice;

                          final quantity_ = _quantityController.text;
                          var finalQuan;

                          try {
                            finalPrice = double.parse(price_);
                          } catch (e) {
                            ScaffoldMessenger.of(context).showSnackBar(
                              SnackBar(
                                content: Text("Price Error: " + e.toString()),
                              ),
                            );
                          }

                          try {
                            finalQuan = int.parse(quantity_);
                          } catch (e) {
                            ScaffoldMessenger.of(context).showSnackBar(
                              SnackBar(
                                content: Text(
                                  "Quantity Error: " + e.toString(),
                                ),
                              ),
                            );
                          }

                          // categoryId based on selectedValue
                          category_Id = int.parse(selectedValue!);

                          switch (category_Id) {
                            case 1:
                              categoryList = ProductList.tShirtList;
                              break;
                            case 2:
                              categoryList = ProductList.poloShirtList;
                              break;
                            case 3:
                              categoryList = ProductList.casualWear;
                              break;
                            default:
                              throw Exception('Invalid categoryId');
                          }

                          final formBloc = context.read<ProductFormBloc>();
                          final state = formBloc.state as ProductFormLoaded;

                          if (state.isEditing && state.selectedProduct != null) {
                            final updatedProduct = state.selectedProduct!.copyWith(
                              name: _productNameController.text,
                              categoryId: int.parse(selectedValue!),
                              description: _descriptionController.text,
                              price: double.parse(_priceController.text),
                              totalQuantity: int.parse(_quantityController.text),
                            );
                            formBloc.add(UpdateProductEvent(updatedProduct));
                          } else {
                            final newProduct = Product(
                              id: state.products.length + 1,
                              name: _productNameController.text,
                              categoryId: int.parse(selectedValue!),
                              image: getRandomImageFromCategory(int.parse(selectedValue!)),
                              description: _descriptionController.text,
                              price: double.parse(_priceController.text),
                              quantity: 1,
                              totalQuantity: int.parse(_quantityController.text),
                            );
                            formBloc.add(AddProductEvent(newProduct));
                          }
                          // If editing an existing product, update it
                          if (isEditingMode && selectedProduct != null) {
                            selectedProduct!.name = _productNameController.text;
                            selectedProduct!.categoryId = category_Id;
                            selectedProduct!.description =
                                _descriptionController.text;
                            selectedProduct!.price = finalPrice;
                            selectedProduct!.totalQuantity = finalQuan;

                          } else {
                            

                            // Choose a random image from category assets
                            String randomImage = getRandomImageFromCategory(
                              category_Id,
                            );

                            int index = allProducts.length;
                            Product newProduct = Product(
                              id: index + 1,
                              name: _productNameController.text,
                              categoryId: category_Id,
                              image: randomImage,
                              description: _descriptionController.text,
                              price: finalPrice,
                              quantity: 1,
                              totalQuantity: finalQuan,
                            );

                            context.read<ProductFormBloc>().add(
                              AddProductEvent(newProduct),
                            );
                            // categoryList.add(newProduct);
                          }

                          // Show success message
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text(
                                isEditingMode
                                    ? "Product updated successfully!"
                                    : "Product added successfully!",
                              ),
                            ),
                          );

                          // Clear the forms
                          _productNameController.clear();
                          _descriptionController.clear();
                          _quantityController.clear();
                          _priceController.clear();
                          setState(() {
                            selectedValue = null;
                            isEditingMode = false;
                          });
                        } else {
                          // errors
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text("Please fill out all fields"),
                            ),
                          );
                        }
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.blue,
                        elevation: 2.0,
                        shadowColor: Colors.black,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(4),
                        ),
                      ),
                      child: Column(
                        children: [
                          Text(
                            isEditingMode ? 'Update Product' : 'Add Product',
                            style: const TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                        ],
                      ),
                    ),

                    ElevatedButton(
                      onPressed: () {
                        _productNameController.clear();
                        _descriptionController.clear();
                        _quantityController.clear();
                        _priceController.clear();
                        setState(() {
                          selectedValue = null;
                          isEditingMode = false;
                        });
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.blue,
                        elevation: 2.0,
                        shadowColor: Colors.black,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(4),
                        ),
                      ),
                      child: Text(
                        'Cancel',
                        style: const TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                    ),

                    isEditingMode
                        ? ElevatedButton(
                          onPressed: () {
                            // categoryId based on selectedValue
                            int categoryId = int.parse(selectedValue!);

                            switch (categoryId) {
                              case 1:
                                categoryList = ProductList.tShirtList;
                                break;
                              case 2:
                                categoryList = ProductList.poloShirtList;
                                break;
                              case 3:
                                categoryList = ProductList.casualWear;
                                break;
                              default:
                                throw Exception('Invalid categoryId');
                            }

                            if (selectedProduct != null) {
                              categoryList.remove(selectedProduct);

                              _productNameController.clear();
                              _descriptionController.clear();
                              _quantityController.clear();
                              _priceController.clear();
                              setState(() {
                                selectedValue = null;
                                isEditingMode = false;
                              });

                              ScaffoldMessenger.of(context).showSnackBar(
                                SnackBar(content: Text("Product Deleted")),
                              );
                            }
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.blue,
                            elevation: 2.0,
                            shadowColor: Colors.black,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(4),
                            ),
                          ),
                          child: Text(
                            'Delete',
                            style: const TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                        )
                        : SizedBox(height: 0),
                  ],
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  String getRandomImageFromCategory(int categoryId) {
                              final random = Random();
                              List<String>? categoryAssets;

                              switch (categoryId) {
                                case 1:
                                  categoryAssets = ProductAssets.tShirtAssets;
                                  break;
                                case 2:
                                  categoryAssets =
                                      ProductAssets.poloShirtAssets;
                                  break;
                                case 3:
                                  categoryAssets = ProductAssets.casualAssets;
                                  break;
                                default:
                                  throw Exception('Invalid category ID');
                              }

                              // Randomly pick an image from the category
                              return categoryAssets[random.nextInt(
                                categoryAssets.length,
                              )];
                            }
}
